from django import template
from datetime import datetime
from khayyam import JalaliDate

register = template.Library()

@register.filter
def string_to_jalali(value, date_format="%Y-%m-%d"):
    """
    ูุฑุถ ูโฺฉูู value ฺฉ ุฑุดุชูู ุชุงุฑุฎ ุจุงุดุฏุ ูุซูุงู "2025-05-25" ุง "2025-05-25 14:30:00".
    ุงู ููุชุฑ ุงุจุชุฏุง ุฑุดุชู ุฑุง ูพูุงุฑุณ ูโฺฉูุฏ (ุจุง ูุฑูุช date_format) ู ุจุนุฏ ุฎุฑูุฌ ุดูุณ ูโุฏูุฏ.
    
    ูพุงุฑุงูุชุฑ date_format:
        ุงูฺฏู strptime ุจุฑุง ูพุงุฑุณ ฺฉุฑุฏู value ุงุณุช. ุจู ุตูุฑุช ูพุดโูุฑุถ "%Y-%m-%d" ูุฑุถ ุดุฏู.
        ุงฺฏุฑ ุฑุดุชูู ุดูุง ูุฑูุช ูุชูุงูุช ุฏุงุฑุฏ (ูุซูุงู "YYYY/MM/DD" ุง ููุฑุงู ุจุง ุฒูุงู)ุ
        ุจุงุฏ date_format ุฑุง ููฺฏุงู ูุฑุงุฎูุงู ููุชุฑ ูุดุฎุต ฺฉูุฏ.
    
    ุฎุฑูุฌ:
        ุฑุดุชูู ุชุงุฑุฎ ุจู ุตูุฑุช ุฌูุงู ุฏุฑ ูุฑูุช ูพุดโูุฑุถ "%Y/%m/%d" ุจุฑูโฺฏุฑุฏุงูุฏ.
        ุงฺฏุฑ ุจุฎูุงูุฏ ูุฑูุช ุฏฺฏุฑ (ูุงููุฏ "ุฑูุฒ ูุงู ุณุงู ุณุงุนุช:ุฏููู") ุฏุงุดุชู ุจุงุดุฏุ
        ูโุชูุงูุฏ ุจุนุฏ ุงุฒ ุงู ููุชุฑุ ุฏูุจุงุฑู ุงุฒ f-string ุง ุฌุง ุฏฺฏุฑ ุงุณุชูุงุฏู ฺฉูุฏ.
    """
    if not value:
        return ""
    try:
        # ุงฺฏุฑ ุฑุดุชู ุฏููุงู ุดุงูู ุชุงุฑุฎ ู ุฒูุงู ุจุงุดุฏุ 
        # ุจูุชุฑ ุงุณุช ุฎูุฏุชุงู ุฏุฑ date_format ุขู ุฑุง ุจููุณุฏุ ูุซุงู: "%Y-%m-%d %H:%M:%S"
        dt = datetime.strptime(value, date_format)
    except ValueError:
        # ุงฺฏุฑ ูพุงุฑุณ ูุณุชูู ุจุง ูุฑูุช ูพุดโูุฑุถ ููฺฉู ูุณุชุ ุณุน ูโฺฉูู ุจุฎุด ุชุงุฑุฎ ุฑุง ุฌุฏุง ฺฉูู
        try:
            # ุจุฎุด ฺฉู ูุจู ุงุฒ ูุงุตูู (space) ุงุณุช ุฑุง ุจู ุนููุงู "YYYY-MM-DD" ุฏุฑ ูุธุฑ ุจฺฏุฑุฏ
            date_part = value.split()[0]
            dt = datetime.strptime(date_part, "%Y-%m-%d")
        except Exception:
            return value  # ุงฺฏุฑ ูุชูุงูุณุชู ูพุงุฑุณ ฺฉููุ ุฎูุฏู ุฑุดุชูู ุฎุงู ุฑุง ุจุฑฺฏุฑุฏุงูู

    # ุงฺฉููู dt ฺฉ ุดุก datetime ุงุณุช (ุจุฑ ุงุณุงุณ ููุทููู ุฒูุงู ุณุฑูุฑ)
    # ุงุฒ JalaliDate ุจุฑุง ุชุจุฏู ููุงุฏุจูโุดูุณ ุงุณุชูุงุฏู ูโฺฉูู
    try:
        jalali_date = JalaliDate(dt.date())
        # ุฎุฑูุฌ ุจู ุตูุฑุช YYYY/MM/DD ุงุณุช:
        return jalali_date.strftime("%Y/%m/%d")
    except Exception:
        return ""


# ููุช ฺฉ ูููุฏุฑ ุดุงูู ูุงู __init__.py ุจุงุดูุ ูพุงุชูู ุงูู ูููุฏุฑ ุฑู ุจูโุนููุงู ฺฉ ูพฺฉุฌ ูุงุจู ุงููพูุฑุช ูโุดูุงุณู.
# โ ณ. ุชุนุฑู alias ุจุฑุง importูุง ุฏุงุฎู

# ุงฺฏู ุณุงุฎุชุงุฑ ูพฺฉุฌุช ูพฺุฏู ุจุงุดูุ ูโุชูู ูุณุฑูุง import ุฑู ุณุงุฏูโุณุงุฒ ฺฉู.
# ๐ฆ ูุซุงู:

# ๐ tools/__init__.py:

# from .math_utils import calculate_price
# from .text_utils import normalize_text

# ๐ ูุงู ุฏฺฏู ุฏุฑ ูพุฑูฺู:

# from tools import calculate_price, normalize_text

# ุฏฺฏู ูุงุฒู ูุณุช ุชู ูพุฑูฺู ุจููุณ:

# from tools.math_utils import calculate_price

# ููุท ูโููุณ from tools import ... ู ฺฉุงุฑ ุฑุงุญุชโุชุฑู.